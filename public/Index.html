<!DOCTYPE html>
<html>
<head>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
  <title>Blackboard - A classic reinvented</title>
  <script src="http://js.leapmotion.com/leap-0.6.3.min.js"></script>
  <script src="https://cdn.socket.io/socket.io-1.4.5.js"></script>
  <script src="http://code.jquery.com/jquery-1.11.1.js"></script>
  <link href="https://fonts.googleapis.com/css?family=Ubuntu" rel="stylesheet">
</head>
<body>
<button type="button"><a href="#" id="save" download="my-file-name.png">Download</a></button>
<button type="button" id="clear" onclick="clearCanvas()">Clear</button>

<canvas id="c" height="100%" width="100%"></canvas>

<style>
* {
  padding: 0px;
  margin: 0px;
  font-family: 'Ubuntu', sans-serif;
}
button {
  position: fixed;
  margin-top: 10px;
  margin-left: 10px;
  padding: 10px 24px;
  background-color: #555555;
  border: none;
  color: white;
  font-size: 15px;
}
button:hover {
  background-color: #a0a0a0;
}
#clear {
  margin-left: 140px;
}
a {
  text-decoration: none;
  color: white;
}
</style>

<script>

  var previousFrame = null;
  var controllerOptions = {enableGestures: true};

  var c;
  var ctx;
  var lastX = 0;
  var lastY = 0;
  var lastlastX = 0;
  var lastlastY = 0;
  var socket = io();

  $(document).ready(function() {

    socket.emit("join room", window.location.search.split('=')[1]);

    c = document.getElementById("c");
    c.height = window.innerHeight;
    c.width = window.innerWidth;

    ctx = c.getContext("2d");
    ctx.fillStyle = "#000000";
    ctx.fillRect(0,0,c.width, c.height);

    socket.on('points', function(msg) {
      var x = (msg[0] + c.offsetWidth / 3)*1.5;
      var y = (c.offsetHeight - msg[1] - 110)*1.1;

      if (lastX != 0) {
        ctx.beginPath();
        ctx.moveTo(lastX, lastY);
        ctx.quadraticCurveTo(lastlastX, lastlastY, x, y);
        ctx.strokeStyle = '#ffffff';
        ctx.stroke();
      }

      lastX = x;
      lastY = y;
      lastlastX = lastX;
      lastlastY = lastY;
    });
    socket.on('clear', function(msg) {
      clearAllCanvas();
    });
  });

  Leap.loop(controllerOptions, function (frame) {
    var pointableOutput = document.getElementById("pointableData");
    var pointableString = "";
    if (frame.pointables.length > 0) {
      var i = 1; //Takes only one finger. Does not care which finger it takes.

      var pointable = frame.pointables[i];

      if (pointable.extended) {
        socket.emit('points', pointable.tipPosition);

        console.log("x " + (pointable.tipPosition[0].toFixed(1) + 300 ) + ", y " + pointable.tipPosition[1].toFixed(1))
      }
    }
    else {
      lastX = 0;
    }
    previousFrame = frame;
  })

  var button = document.getElementById('save');
  button.addEventListener('click', function (e) {
    var dataURL = c.toDataURL('image/png');
    button.href = dataURL;
  });
  function clearCanvas() {
    socket.emit('clear', [])
  }
  function clearAllCanvas() {
    ctx.fillStyle = "#000000";
    ctx.fillRect(0,0,c.width, c.height);
  }
</script>
</body>
</html>
